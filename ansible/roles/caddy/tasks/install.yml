---
- name: Add Caddy GPG key
  apt_key:
    url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
    state: present
  tags: ['install']

- name: Add Caddy repository
  apt_repository:
    repo: "deb https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
    state: present
    filename: caddy-stable
  tags: ['install']

- name: Update apt cache after adding repository
  apt:
    update_cache: yes
  tags: ['install']

- name: Install Caddy
  apt:
    name: caddy
    state: present
  tags: ['install']

- name: Create caddy user
  user:
    name: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    system: yes
    shell: /usr/sbin/nologin
    home: "{{ caddy_data_dir }}"
    create_home: yes
  tags: ['install']

- name: Create Caddy directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    mode: '0755'
  loop:
    - "{{ caddy_config_dir }}"
    - "{{ caddy_data_dir }}"
    - "{{ caddy_log_dir }}"
  tags: ['install']

- name: Set ownership of Caddy data directory
  file:
    path: "{{ caddy_data_dir }}"
    owner: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    recurse: yes
  tags: ['install']

- name: Check if Caddy binary exists and get version
  command: caddy version
  register: caddy_version
  changed_when: false
  failed_when: false
  tags: ['install']

- name: Display Caddy version
  debug:
    msg: "Caddy version: {{ caddy_version.stdout }}"
  when: caddy_version.rc == 0
  tags: ['install']
