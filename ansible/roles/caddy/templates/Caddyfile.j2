# Global options
{
	# Email for Let's Encrypt (fallback if Cloudflare fails)
	email {{ cloudflare_email }}
	
	# Use Cloudflare DNS for ACME challenges
	acme_dns cloudflare {{ cloudflare_api_token }}
	
	# Global log settings
	log {
		output file {{ caddy_log_dir }}/access.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
		level {{ log_level }}
	}
	
	# Security headers
	header {
{% for header in security_headers %}
		{{ header }}
{% endfor %}
	}
}

# Redirect HTTP to HTTPS
http:// {
	redir https://{host}{uri} permanent
}

{% for service_name, service_config in services.items() %}
# {{ service_config.description }}
{{ service_config.subdomain }}.{{ domain_name }} {
	# Reverse proxy to {{ service_name }}
	reverse_proxy {{ service_config.upstream }} {
		# Health check
		health_uri /
		health_interval 30s
		health_timeout 5s
		
		# Headers for better compatibility
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
	}
	
	# Logging for this service
	log {
		output file {{ caddy_log_dir }}/{{ service_name }}.log {
			roll_size 50mb
			roll_keep 3
			roll_keep_for 168h
		}
		format json
	}
	
	# Additional security headers for this service
	header {
		# Remove server information
		-Server
		
		# Content Security Policy (adjust as needed for your services)
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none';"
	}
	
	# Error handling
	handle_errors {
		@5xx expression {http.error.status_code} >= 500
		handle @5xx {
			respond "Service temporarily unavailable" 503
		}
		
		@4xx expression {http.error.status_code} >= 400
		handle @4xx {
			respond "Not found" 404
		}
	}
}

{% endfor %}

# Health check endpoint for the proxy itself
health.{{ domain_name }} {
	respond "OK" 200
	
	log {
		output file {{ caddy_log_dir }}/health.log {
			roll_size 10mb
			roll_keep 2
			roll_keep_for 24h
		}
	}
}

# Catch-all for undefined subdomains
*.{{ domain_name }} {
	respond "Subdomain not configured" 404
	
	log {
		output file {{ caddy_log_dir }}/undefined.log {
			roll_size 10mb
			roll_keep 2
			roll_keep_for 24h
		}
	}
}
